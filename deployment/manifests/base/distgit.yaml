---
apiVersion: v1
kind: Pod
metadata:
  name: copr-distgit
  labels:
    app: copr
    component: distgit
spec:
  hostname: distgit
  containers:
    # DistGit import service
    - name: distgit
      image: copr-distgit:latest
      command:
        - /usr/bin/tini
        - "--"
        - bash
        - "-c"
        - "mkdir -p /var/lib/dist-git/cache /var/lib/dist-git/git && exec /usr/bin/copr-run-dispatcher-dist-git imports"
      volumeMounts:
        - name: distgit-data
          mountPath: /var/lib/dist-git
        - name: distgit-logs
          mountPath: /var/lib/copr-dist-git
      resources:
        limits:
          memory: "512Mi"
          cpu: "500m"

    # DistGit HTTPD (CGit)
    - name: distgit-httpd
      image: copr-distgit:latest
      command:
        - /usr/sbin/httpd
        - "-DFOREGROUND"
      ports:
        - containerPort: 5001
          protocol: TCP
      volumeMounts:
        - name: distgit-data
          mountPath: /var/lib/dist-git
        - name: distgit-logs
          mountPath: /var/lib/copr-dist-git
      readinessProbe:
        httpGet:
          path: /
          port: 5001
        initialDelaySeconds: 5
        periodSeconds: 10
        timeoutSeconds: 5
      livenessProbe:
        httpGet:
          path: /
          port: 5001
        initialDelaySeconds: 15
        periodSeconds: 30
        timeoutSeconds: 5
      resources:
        limits:
          memory: "256Mi"
          cpu: "200m"

  volumes:
    - name: distgit-data
      persistentVolumeClaim:
        claimName: copr-distgit-data
    - name: distgit-logs
      emptyDir: {}
  restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: distgit
spec:
  selector:
    component: distgit
  ports:
    - port: 5001
      targetPort: 5001
      protocol: TCP

