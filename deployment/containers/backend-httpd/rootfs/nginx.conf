# COPR Backend HTTP server for serving build results

worker_processes auto;
error_log /dev/stderr;
pid /tmp/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent"';

    access_log /dev/stdout main;
    sendfile on;
    keepalive_timeout 65;

    server {
        listen 5002;
        listen [::]:5002;
        server_tokens off;
        server_name localhost;
        charset utf-8;

        root /var/lib/copr/public_html/;
        default_type text/plain;

        # Proxy resalloc WebUI (like lighttpd CGI in production)
        # Uses variable to force runtime DNS resolution (not startup-cached)
        # NGINX_RESOLVER is substituted at container startup from /etc/resolv.conf
        resolver NGINX_RESOLVER valid=30s ipv6=off;
        location /resalloc {
            set $resalloc_backend http://resalloc:5000;
            proxy_pass $resalloc_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Script-Name /resalloc;
        }

        location / {
            port_in_redirect off;
            autoindex on;
        }

        # Serve .log.gz files with proper content-encoding
        location ~* \.log\.gz$ {
            add_header Content-Encoding gzip;
            add_header Content-Type "text/plain; charset=utf-8";
        }

        # Other .gz files
        location ~* \.gz$ {
            add_header Content-Encoding gzip;
        }

        # Disable caching for repomd.xml
        location ~* /repomd\.xml$ {
            add_header Cache-Control "no-cache";
        }

        # Disable caching for .log files
        location ~* \.log$ {
            add_header Cache-Control "no-store";
            default_type "text/plain; charset=utf-8";
        }
    }
}
