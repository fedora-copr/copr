---
- name: install resalloc server
  package:
    name:
      - postgresql-server
      - resalloc-server
    state: installed

- name: Create PostgreSQL user 'resalloc'
  community.postgresql.postgresql_user:
    login_db: postgres
    name: resalloc
    state: present
  become: true
  become_user: postgres

- name: Create PostgreSQL database 'resalloc' owned by 'resalloc'
  community.postgresql.postgresql_db:
    name: resalloc
    owner: resalloc
    state: present
  become: true
  become_user: postgres
  register: db_created

- name: Configure Resalloc Server
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "/etc/resallocserver/{{ item }}"
    owner: resalloc
    group: resalloc
    mode: '0600'
  loop:
    - server.yaml
    - pools.yaml

- name: Start and enable Resalloc service
  ansible.builtin.systemd_service:
    name: resalloc
    state: started
    enabled: true

- name: create image builder directory
  ansible.builtin.file:
    path: "{{ resalloc_image_dir }}"
    state: directory
    owner: resalloc
    group: resalloc
    mode: '0700'

- name: Enable user lingering for 'resalloc'
  ansible.builtin.command: loginctl enable-linger resalloc
  changed_when: false

- name: render Containerfile
  ansible.builtin.template:
    src: Containerfile.j2
    # Cílový soubor, který se bude používat pro podman build
    dest: "{{ resalloc_image_dir }}/Containerfile"
    owner: resalloc
    group: resalloc
    mode: '0600'
  register: containerfile

- name: build the image
  ansible.builtin.command:
    cmd: "podman build -t builder_x86_64 ."
  args:
    chdir: "{{ resalloc_image_dir }}"
  when: containerfile.changed
  become: true
  become_user: resalloc

- name: Ensure resalloc user has subordinate UIDs defined
  ansible.builtin.lineinfile:
    path: "{{ item }}"
    regexp: '^resalloc:'
    line: 'resalloc:100000:65536'
    state: present
    create: true
  loop:
    - /etc/subuid
    - /etc/subgid

- name: Ensure ~/.ssh directory exists for resalloc user
  ansible.builtin.file:
    path: /var/lib/resallocserver/.ssh
    state: directory
    owner: resalloc
    group: resalloc
    mode: '0700'

- name: Fetch the Backend->Builder SSH private key
  ansible.builtin.slurp:
    src: /root/backend_builder
  delegate_to: "{{ host_with_secrets }}"
  register: key_file

- name: Install the fetched SSH private key
  ansible.builtin.copy:
    content: "{{ key_file['content'] | b64decode }}"
    dest: "/var/lib/resallocserver/.ssh/id_ed25519"
    owner: resalloc
    group: resalloc
    mode: '0600'

- name: Fetch the Backend->Builder SSH public key
  ansible.builtin.slurp:
    src: /root/backend_builder.pub
  delegate_to: "{{ host_with_secrets }}"
  register: key_file

- name: Install the fetched SSH public key
  ansible.builtin.copy:
    content: "{{ key_file['content'] | b64decode }}"
    dest: "{{ resalloc_image_dir }}/key.pub"
    owner: resalloc
    group: resalloc
    mode: '0600'
