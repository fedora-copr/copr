---
# Database Pod
apiVersion: v1
kind: Pod
metadata:
  name: copr-database
  labels:
    app: copr
    component: database
spec:
  hostname: database
  containers:
    - name: database
      image: copr-database:latest
      imagePullPolicy: Never
      env:
        - name: POSTGRESQL_USER
          value: "copr-fe"
        - name: POSTGRESQL_PASSWORD
          value: "coprpass"
        - name: POSTGRESQL_DATABASE
          value: "coprdb"
      ports:
        - containerPort: 5432
          hostPort: 5009
          protocol: TCP
      volumeMounts:
        - name: database-data
          mountPath: /var/lib/pgsql/data
  volumes:
    - name: database-data
      persistentVolumeClaim:
        claimName: copr-database-data
  restartPolicy: Always

---
# Redis Pod
apiVersion: v1
kind: Pod
metadata:
  name: copr-redis
  labels:
    app: copr
    component: redis
spec:
  hostname: redis
  containers:
    - name: redis
      image: copr-redis:latest
      imagePullPolicy: Never
      ports:
        - containerPort: 6379
          protocol: TCP
      volumeMounts:
        - name: redis-data
          mountPath: /data
  volumes:
    - name: redis-data
      persistentVolumeClaim:
        claimName: copr-redis-data
  restartPolicy: Always

---
# Frontend Pod
apiVersion: v1
kind: Pod
metadata:
  name: copr-frontend
  labels:
    app: copr
    component: frontend
spec:
  hostname: frontend
  containers:
    - name: frontend
      image: copr-frontend:latest
      imagePullPolicy: Never
      env:
        - name: REDIS_HOST
          value: "copr-redis"
      ports:
        - containerPort: 5000
          hostPort: 5000
          protocol: TCP
  restartPolicy: Always

---
# Backend HTTPD Pod (results server)
apiVersion: v1
kind: Pod
metadata:
  name: copr-backend-httpd
  labels:
    app: copr
    component: backend-httpd
spec:
  hostname: backend-httpd
  containers:
    - name: backend-httpd
      image: copr-backend-httpd:latest
      imagePullPolicy: Never
      ports:
        - containerPort: 5002
          hostPort: 5002
          protocol: TCP
      volumeMounts:
        - name: results-data
          mountPath: /var/lib/copr/public_html/results
  volumes:
    - name: results-data
      persistentVolumeClaim:
        claimName: copr-results-data
  restartPolicy: Always

---
# Backend Services Pod (log, build, action)
apiVersion: v1
kind: Pod
metadata:
  name: copr-backend
  labels:
    app: copr
    component: backend
spec:
  hostname: backend
  containers:
    # Log service
    - name: backend-log
      image: copr-backend:latest
      imagePullPolicy: Never
      command:
        - /usr/bin/tini
        - "--"
        - /usr/bin/copr_run_logger.py
      volumeMounts:
        - name: results-data
          mountPath: /var/lib/copr/public_html/results

    # Build dispatcher
    - name: backend-build
      image: copr-backend:latest
      imagePullPolicy: Never
      securityContext:
        capabilities:
          add:
            - NET_BIND_SERVICE
      command:
        - /usr/bin/tini
        - "--"
        - /run-backend
        - "--sign-host"
        - "copr-keygen"
        - /usr/bin/copr-run-dispatcher-backend
        - builds
      volumeMounts:
        - name: results-data
          mountPath: /var/lib/copr/public_html/results

    # Action dispatcher
    - name: backend-action
      image: copr-backend:latest
      imagePullPolicy: Never
      securityContext:
        capabilities:
          add:
            - NET_BIND_SERVICE
      command:
        - /usr/bin/tini
        - "--"
        - /run-backend
        - "--sign-host"
        - "copr-keygen"
        - /usr/bin/copr-run-dispatcher-backend
        - actions
      volumeMounts:
        - name: results-data
          mountPath: /var/lib/copr/public_html/results

  volumes:
    - name: results-data
      persistentVolumeClaim:
        claimName: copr-results-data
  restartPolicy: Always

---
# DistGit Pod
apiVersion: v1
kind: Pod
metadata:
  name: copr-distgit
  labels:
    app: copr
    component: distgit
spec:
  hostname: distgit
  containers:
    # DistGit import service
    - name: distgit
      image: copr-distgit:latest
      imagePullPolicy: Never
      command:
        - /usr/bin/tini
        - "--"
        - bash
        - "-c"
        - "mkdir -p /var/lib/dist-git/cache /var/lib/dist-git/git && exec /usr/bin/copr-run-dispatcher-dist-git imports"
      volumeMounts:
        - name: distgit-data
          mountPath: /var/lib/dist-git
        - name: distgit-logs
          mountPath: /var/lib/copr-dist-git

    # DistGit HTTPD (CGit)
    - name: distgit-httpd
      image: copr-distgit:latest
      imagePullPolicy: Never
      command:
        - /usr/sbin/httpd
        - "-DFOREGROUND"
      ports:
        - containerPort: 5001
          hostPort: 5001
          protocol: TCP
      volumeMounts:
        - name: distgit-data
          mountPath: /var/lib/dist-git
        - name: distgit-logs
          mountPath: /var/lib/copr-dist-git

  volumes:
    - name: distgit-data
      persistentVolumeClaim:
        claimName: copr-distgit-data
    - name: distgit-logs
      emptyDir: {}
  restartPolicy: Always

---
# Keygen Pod (signd + httpd)
apiVersion: v1
kind: Pod
metadata:
  name: copr-keygen
  labels:
    app: copr
    component: keygen
spec:
  hostname: keygen
  containers:
    # Signd service (GPG signing daemon)
    - name: keygen-signd
      image: copr-keygen:latest
      imagePullPolicy: Never
      command:
        - /usr/bin/tini
        - "--"
        - /signd-entrypoint
      ports:
        - containerPort: 5167
          protocol: TCP
      volumeMounts:
        - name: keygen-data
          mountPath: /var/lib/copr-keygen

    # Keygen HTTPD (key generation API)
    - name: keygen-httpd
      image: copr-keygen:latest
      imagePullPolicy: Never
      command:
        - /usr/bin/tini
        - "--"
        - /bin/bash
        - "-c"
        - "mkdir --mode=0777 -p /var/lib/copr-keygen/phrases /var/lib/copr-keygen/gnupg && mkdir --mode=0777 -p /var/run/httpd && exec /usr/sbin/httpd -DFOREGROUND"
      ports:
        - containerPort: 5003
          protocol: TCP
      volumeMounts:
        - name: keygen-data
          mountPath: /var/lib/copr-keygen

  volumes:
    - name: keygen-data
      persistentVolumeClaim:
        claimName: copr-keygen-data
  restartPolicy: Always

---
# Resalloc Pod
apiVersion: v1
kind: Pod
metadata:
  name: copr-resalloc
  labels:
    app: copr
    component: resalloc
spec:
  hostname: resalloc
  containers:
    # Resalloc server
    - name: resalloc
      image: copr-resalloc:latest
      imagePullPolicy: Never
      command:
        - /bin/bash
        - "-c"
        - "cd $(rpm -ql resalloc-server |grep alembic.ini |xargs dirname) && alembic-3 upgrade head && /usr/bin/resalloc-server"
      ports:
        - containerPort: 49100
          protocol: TCP
      volumeMounts:
        - name: resalloc-data
          mountPath: /persistent

    # Resalloc WebUI (optional, for debugging)
    - name: resalloc-webui
      image: copr-resalloc:latest
      imagePullPolicy: Never
      command:
        - python3
        - "-c"
        - "from resallocwebui.app import app; app.run(host='0.0.0.0')"
      ports:
        - containerPort: 5000
          hostPort: 5005
          protocol: TCP
      volumeMounts:
        - name: resalloc-data
          mountPath: /persistent

  volumes:
    - name: resalloc-data
      persistentVolumeClaim:
        claimName: copr-resalloc-data
  restartPolicy: Always

---
# Builder Pod
apiVersion: v1
kind: Pod
metadata:
  name: copr-builder
  labels:
    app: copr
    component: builder
spec:
  hostname: builder
  containers:
    - name: builder
      image: copr-builder:latest
      imagePullPolicy: Never
      ports:
        - containerPort: 22
          protocol: TCP
      securityContext:
        privileged: true
  restartPolicy: Always
