---
apiVersion: v1
kind: Pod
metadata:
  name: copr-distgit
  namespace: copr
  labels:
    app: copr
    component: distgit
spec:
  containers:
    # DistGit import service
    - name: distgit
      image: copr-distgit:latest
      imagePullPolicy: Never
      command:
        [
          "/usr/bin/tini",
          "--",
          "bash",
          "-c",
          "mkdir -p /var/lib/dist-git/cache /var/lib/dist-git/git && exec /usr/bin/copr-run-dispatcher-dist-git imports",
        ]
      volumeMounts:
        - name: distgit-data
          mountPath: /var/lib/dist-git
      resources:
        limits:
          memory: "512Mi"
          cpu: "500m"

    # DistGit HTTPD (CGit)
    - name: distgit-httpd
      image: copr-distgit:latest
      imagePullPolicy: Never
      command: ["/usr/sbin/httpd", "-DFOREGROUND"]
      ports:
        - containerPort: 5001
          hostPort: 5001
          protocol: TCP
      volumeMounts:
        - name: distgit-data
          mountPath: /var/lib/dist-git
      resources:
        limits:
          memory: "256Mi"
          cpu: "200m"

  volumes:
    - name: distgit-data
      persistentVolumeClaim:
        claimName: copr-distgit-data

  restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: distgit
  namespace: copr
spec:
  selector:
    component: distgit
  ports:
    - port: 5001
      targetPort: 5001
      protocol: TCP
