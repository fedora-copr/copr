FROM copr-base:latest

LABEL description="PostgreSQL database for COPR"

RUN --mount=type=cache,target=/var/cache/dnf \
    dnf -y install postgresql-server postgresql && \
    dnf clean all

RUN mkdir -p /var/lib/pgsql/data /var/run/postgresql && \
    chown -R postgres:postgres /var/lib/pgsql /var/run/postgresql

COPY files/init-db.sh /usr/local/bin/init-db.sh
RUN chmod +x /usr/local/bin/init-db.sh

USER postgres
EXPOSE 5432
HEALTHCHECK --interval=10s --timeout=5s --start-period=30s \
    CMD pg_isready -U postgres || exit 1

ENTRYPOINT []
CMD ["/usr/local/bin/init-db.sh"]
