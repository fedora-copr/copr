#!/bin/bash
# Frontend entrypoint for local development

# TODO: AI generated entrypoint, refactor
set -e

cd /usr/share/copr/coprs_frontend/

# Initialize database if needed
./manage.py create-db --alembic alembic.ini

# Create chroots for development
# Fedora stable releases
./manage.py create-chroot fedora-43-x86_64
./manage.py create-chroot fedora-43-i386
./manage.py create-chroot fedora-43-aarch64
./manage.py create-chroot fedora-42-x86_64
./manage.py create-chroot fedora-42-i386
./manage.py create-chroot fedora-42-aarch64
./manage.py create-chroot fedora-41-x86_64
./manage.py create-chroot fedora-41-i386
./manage.py create-chroot fedora-41-aarch64

# Fedora rawhide
./manage.py create-chroot fedora-rawhide-x86_64
./manage.py create-chroot fedora-rawhide-i386
./manage.py create-chroot fedora-rawhide-aarch64

# EPEL
./manage.py create-chroot epel-9-x86_64
./manage.py create-chroot epel-9-aarch64
./manage.py create-chroot epel-8-x86_64
./manage.py create-chroot epel-8-aarch64

# Rebuild search indexes if needed
if ! ./manage.py update_indexes_required 2>/dev/null; then
    echo "Rebuilding search indexes..."
    ./manage.py update_indexes || true
fi

# Create directories (already created in Containerfile, this is fallback)
mkdir -p /var/www/html/db_dumps /var/www/html/usage 2>/dev/null || true

# Create default development user (for local testing without real auth)
DEV_USER="${TEST_REMOTE_USER:-jdoe}"
if ! ./manage.py add-user "$DEV_USER" "${DEV_USER}@localhost" 2>/dev/null; then
    echo "User $DEV_USER already exists"
fi
./manage.py alter-user "$DEV_USER" --admin || true
echo "Development user '$DEV_USER' ready (admin)"

# Create test groups and add user to them (for beaker tests)
# The @copr group is expected by sanity tests
python3 << 'EOF'
import sys
sys.path.insert(0, '/usr/share/copr/coprs_frontend')
from coprs import app, db
from coprs.models import Group, User

with app.app_context():
    # Create @copr group (used by beaker tests)
    groups_to_create = [
        ('copr', 'gitcopr'),      # @copr group with fas_name gitcopr
        ('mock', 'gitmock'),      # @mock group
    ]

    for name, fas_name in groups_to_create:
        existing = Group.query.filter(Group.name == name).first()
        if not existing:
            group = Group(name=name, fas_name=fas_name)
            db.session.add(group)
            print(f"Created group @{name} (fas: {fas_name})")
        else:
            print(f"Group @{name} already exists")

    # Add jdoe to these groups by setting user_teams
    user = User.query.filter(User.username == 'jdoe').first()
    if user:
        # user_teams is stored as a string, space-separated
        teams = ['gitcopr', 'gitmock']
        # Merge with existing teams if any
        existing_teams = set(user.openid_groups.split() if user.openid_groups else [])
        existing_teams.update(teams)
        user.openid_groups = ' '.join(existing_teams)
        print(f"User jdoe added to groups: {teams}")

    db.session.commit()
    print("Groups setup complete")
EOF

# Set test user for simulated Kerberos auth
export TEST_REMOTE_USER="$DEV_USER"

# Start Apache
exec /usr/sbin/httpd -DFOREGROUND
