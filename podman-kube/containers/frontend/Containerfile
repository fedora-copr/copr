FROM copr-base:latest

LABEL description="COPR Frontend - Web UI and API"

ENV REDIS_HOST=redis

RUN --mount=type=cache,target=/var/cache/dnf \
    dnf -y install \
        copr-frontend \
        mock-core-configs \
        modulemd-tools \
        python3-alembic \
        python3-anytree \
        python3-authlib \
    && dnf clean all

COPY files/ /

RUN set -ex && \
    sed -i \
        -e 's/User apache/User copr-fe/g' \
        -e 's/Group apache/Group copr-fe/g' \
        -e 's/Listen 80/#Listen 80/g' \
        /etc/httpd/conf/httpd.conf && \
    echo "PidFile /var/run/httpd/httpd.pid" >> /etc/httpd/conf/httpd.conf && \
    sed -i "s/REDIS_HOST = \"redis\"/REDIS_HOST = \"${REDIS_HOST}\"/g" /etc/copr/copr.conf && \
    chown -R copr-fe:root /usr/share/copr /var/log/copr-frontend /etc/httpd /var/run/httpd /var/log/httpd && \
    chmod -R g+rwX /usr/share/copr /var/log/copr-frontend /etc/httpd /var/run/httpd /var/log/httpd

USER copr-fe
EXPOSE 5000
HEALTHCHECK --interval=30s --timeout=5s --start-period=60s \
    CMD curl -sf http://localhost:5000/api_3/ping || exit 1

ENTRYPOINT []
CMD ["/entrypoint"]
